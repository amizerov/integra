'use server'

import { prisma } from '@/lib/db'
import { auth } from '@/lib/auth'
import { revalidatePath } from 'next/cache'
import { z } from 'zod'

// Схемы валидации
const systemSchema = z.object({
  systemCode: z.string().min(1, 'Код системы обязателен'),
  systemName: z.string().min(1, 'Название системы обязательно'),
  shortName: z.string().optional(),
  description: z.string().optional(),
  isActive: z.boolean().default(true),
})

const versionSchema = z.object({
  systemId: z.number(),
  versionNumber: z.number(),
  versionCode: z.string(),
  versionType: z.enum(['PRODUCTION', 'DEVELOPMENT', 'TESTING', 'ARCHIVED', 'PILOT']),
  platformType: z.enum(['WEB', 'DESKTOP', 'ONE_C', 'MOBILE', 'HYBRID', 'API_ONLY']),
  yearDevelopmentStart: z.number().optional(),
  yearDevelopmentEnd: z.number().optional(),
  yearOperationStart: z.number().optional(),
  yearOperationEnd: z.number().optional(),
  developerDepartment: z.string().optional(),
  operatorDepartment: z.string().optional(),
  databaseType: z.enum(['POSTGRESQL', 'MYSQL', 'MARIADB', 'MSSQL', 'ORACLE', 'ONE_C_DB', 'MONGODB', 'SQLITE', 'OTHER']),
  isCompatibleWithOthers: z.boolean().default(true),
  databaseShared: z.boolean().default(false),
  isActive: z.boolean().default(true),
  isMaster: z.boolean().default(false),
  comment: z.string().optional(),
})

// ============= СИСТЕМЫ =============

export async function getSystems(filters?: {
  search?: string
  isActive?: boolean
  page?: number
  limit?: number
}) {
  const session = await auth()
  if (!session?.user) {
    throw new Error('Не авторизован')
  }

  const { search, isActive, page = 1, limit = 20 } = filters || {}
  const skip = (page - 1) * limit

  const where: any = {}

  if (search) {
    where.OR = [
      { systemName: { contains: search, mode: 'insensitive' } },
      { systemCode: { contains: search, mode: 'insensitive' } },
    ]
  }

  if (isActive !== undefined) {
    where.isActive = isActive
  }

  const [systems, total] = await Promise.all([
    prisma.system.findMany({
      where,
      include: {
        _count: {
          select: {
            versions: true,
            outgoingConnections: true,
            incomingConnections: true,
          },
        },
      },
      orderBy: { systemName: 'asc' },
      skip,
      take: limit,
    }),
    prisma.system.count({ where }),
  ])

  return {
    systems,
    pagination: {
      total,
      page,
      limit,
      pages: Math.ceil(total / limit),
    },
  }
}

export async function getSystemById(id: number) {
  const session = await auth()
  if (!session?.user) {
    throw new Error('Не авторизован')
  }

  const system = await prisma.system.findUnique({
    where: { id },
    include: {
      versions: {
        orderBy: { versionNumber: 'desc' },
      },
      outgoingConnections: {
        include: {
          targetSystem: true,
          targetVersion: true,
        },
      },
      incomingConnections: {
        include: {
          sourceSystem: true,
          sourceVersion: true,
        },
      },
      documents: {
        include: {
          document: {
            include: {
              documentType: true,
            },
          },
        },
      },
      creator: {
        select: {
          name: true,
          email: true,
        },
      },
      modifier: {
        select: {
          name: true,
          email: true,
        },
      },
    },
  })

  return system
}

export async function createSystem(formData: FormData) {
  const session = await auth()
  if (!session?.user) {
    throw new Error('Не авторизован')
  }

  const rawData = {
    systemCode: formData.get('systemCode') as string,
    systemName: formData.get('systemName') as string,
    shortName: formData.get('shortName') as string || undefined,
    description: formData.get('description') as string || undefined,
    isActive: formData.get('isActive') === 'true',
  }

  const validated = systemSchema.parse(rawData)

  const system = await prisma.system.create({
    data: {
      ...validated,
      createdById: session.user.id,
      updatedById: session.user.id,
    },
  })

  revalidatePath('/systems')
  revalidatePath('/dashboard')

  return { success: true, system }
}

export async function updateSystem(id: number, formData: FormData) {
  const session = await auth()
  if (!session?.user) {
    throw new Error('Не авторизован')
  }

  const rawData = {
    systemCode: formData.get('systemCode') as string,
    systemName: formData.get('systemName') as string,
    shortName: formData.get('shortName') as string || undefined,
    description: formData.get('description') as string || undefined,
    isActive: formData.get('isActive') === 'true',
  }

  const validated = systemSchema.parse(rawData)

  const system = await prisma.system.update({
    where: { id },
    data: {
      ...validated,
      updatedById: session.user.id,
    },
  })

  revalidatePath('/systems')
  revalidatePath(`/systems/${id}`)
  revalidatePath('/dashboard')

  return { success: true, system }
}

export async function deleteSystem(id: number) {
  const session = await auth()
  if (!session?.user) {
    throw new Error('Не авторизован')
  }

  await prisma.system.delete({
    where: { id },
  })

  revalidatePath('/systems')
  revalidatePath('/dashboard')

  return { success: true }
}

// ============= ВЕРСИИ СИСТЕМ =============

export async function getVersionsBySystemId(systemId: number) {
  const session = await auth()
  if (!session?.user) {
    throw new Error('Не авторизован')
  }

  const versions = await prisma.systemVersion.findMany({
    where: { systemId },
    include: {
      system: {
        select: {
          systemCode: true,
          systemName: true,
        },
      },
      creator: {
        select: {
          name: true,
          email: true,
        },
      },
    },
    orderBy: { versionNumber: 'desc' },
  })

  return versions
}

export async function createVersion(formData: FormData) {
  const session = await auth()
  if (!session?.user) {
    throw new Error('Не авторизован')
  }

  const rawData = {
    systemId: parseInt(formData.get('systemId') as string),
    versionNumber: parseInt(formData.get('versionNumber') as string),
    versionCode: formData.get('versionCode') as string,
    versionType: formData.get('versionType') as any,
    platformType: formData.get('platformType') as any,
    databaseType: formData.get('databaseType') as any,
    yearDevelopmentStart: formData.get('yearDevelopmentStart') ? parseInt(formData.get('yearDevelopmentStart') as string) : undefined,
    yearDevelopmentEnd: formData.get('yearDevelopmentEnd') ? parseInt(formData.get('yearDevelopmentEnd') as string) : undefined,
    yearOperationStart: formData.get('yearOperationStart') ? parseInt(formData.get('yearOperationStart') as string) : undefined,
    yearOperationEnd: formData.get('yearOperationEnd') ? parseInt(formData.get('yearOperationEnd') as string) : undefined,
    developerDepartment: formData.get('developerDepartment') as string || undefined,
    operatorDepartment: formData.get('operatorDepartment') as string || undefined,
    isCompatibleWithOthers: formData.get('isCompatibleWithOthers') === 'true',
    databaseShared: formData.get('databaseShared') === 'true',
    isActive: formData.get('isActive') === 'true',
    isMaster: formData.get('isMaster') === 'true',
    comment: formData.get('comment') as string || undefined,
  }

  const validated = versionSchema.parse(rawData)

  const version = await prisma.systemVersion.create({
    data: {
      ...validated,
      createdById: session.user.id,
      updatedById: session.user.id,
    },
  })

  revalidatePath('/systems')
  revalidatePath(`/systems/${validated.systemId}`)
  revalidatePath('/dashboard')

  return { success: true, version }
}

export async function updateVersion(id: number, formData: FormData) {
  const session = await auth()
  if (!session?.user) {
    throw new Error('Не авторизован')
  }

  const rawData = {
    systemId: parseInt(formData.get('systemId') as string),
    versionNumber: parseInt(formData.get('versionNumber') as string),
    versionCode: formData.get('versionCode') as string,
    versionType: formData.get('versionType') as any,
    platformType: formData.get('platformType') as any,
    databaseType: formData.get('databaseType') as any,
    yearDevelopmentStart: formData.get('yearDevelopmentStart') ? parseInt(formData.get('yearDevelopmentStart') as string) : undefined,
    yearDevelopmentEnd: formData.get('yearDevelopmentEnd') ? parseInt(formData.get('yearDevelopmentEnd') as string) : undefined,
    yearOperationStart: formData.get('yearOperationStart') ? parseInt(formData.get('yearOperationStart') as string) : undefined,
    yearOperationEnd: formData.get('yearOperationEnd') ? parseInt(formData.get('yearOperationEnd') as string) : undefined,
    developerDepartment: formData.get('developerDepartment') as string || undefined,
    operatorDepartment: formData.get('operatorDepartment') as string || undefined,
    isCompatibleWithOthers: formData.get('isCompatibleWithOthers') === 'true',
    databaseShared: formData.get('databaseShared') === 'true',
    isActive: formData.get('isActive') === 'true',
    isMaster: formData.get('isMaster') === 'true',
    comment: formData.get('comment') as string || undefined,
  }

  const validated = versionSchema.parse(rawData)

  const version = await prisma.systemVersion.update({
    where: { id },
    data: {
      ...validated,
      updatedById: session.user.id,
    },
  })

  revalidatePath('/systems')
  revalidatePath(`/systems/${validated.systemId}`)
  revalidatePath('/dashboard')

  return { success: true, version }
}

export async function deleteVersion(id: number, systemId: number) {
  const session = await auth()
  if (!session?.user) {
    throw new Error('Не авторизован')
  }

  await prisma.systemVersion.delete({
    where: { id },
  })

  revalidatePath('/systems')
  revalidatePath(`/systems/${systemId}`)
  revalidatePath('/dashboard')

  return { success: true }
}

// ============= СТАТИСТИКА =============

export async function getDashboardStats() {
  const session = await auth()
  if (!session?.user) {
    throw new Error('Не авторизован')
  }

  const [
    totalSystems,
    activeSystems,
    totalVersions,
    activeVersions,
    totalConnections,
    systemsByPlatform,
    systemsByDatabase,
    recentSystems,
  ] = await Promise.all([
    prisma.system.count(),
    prisma.system.count({ where: { isActive: true } }),
    prisma.systemVersion.count(),
    prisma.systemVersion.count({ where: { isActive: true } }),
    prisma.connection.count(),
    prisma.systemVersion.groupBy({
      by: ['platformType'],
      _count: true,
      where: { isActive: true },
    }),
    prisma.systemVersion.groupBy({
      by: ['databaseType'],
      _count: true,
      where: { isActive: true },
    }),
    prisma.system.findMany({
      take: 5,
      orderBy: { updatedAt: 'desc' },
      select: {
        id: true,
        systemCode: true,
        systemName: true,
        updatedAt: true,
      },
    }),
  ])

  return {
    totalSystems,
    activeSystems,
    totalVersions,
    activeVersions,
    totalConnections,
    systemsByPlatform: systemsByPlatform.map((item: any) => ({
      platform: item.platformType,
      count: item._count,
    })),
    systemsByDatabase: systemsByDatabase.map((item: any) => ({
      database: item.databaseType,
      count: item._count,
    })),
    recentSystems,
  }
}
